<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mockup Saved Project</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* Sidebar trái */
    #leftPanel { width: 200px; background: #f8f8f8; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; }
    #leftPanel h3 { text-align: center; margin: 10px 0; }
    #leftPanel img { width: 100%; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    #leftPanel img:hover { border: 1px solid #007bff; }

    /* Sidebar phải */
    #rightPanel { width: 180px; background: #f8f8f8; overflow-y: auto; border-left: 1px solid #ccc; padding: 10px; }
    #rightPanel h3 { text-align: center; margin: 10px 0; }
    #rightPanel img { width: 100%; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    #rightPanel img:hover { border: 1px solid #007bff; }

    /* Khung giữa */
    #centerPanel { flex: 1; display: flex; flex-direction: column; background: #eee; justify-content: center; align-items: center; overflow: hidden; position: relative; }
    #canvasWrapper { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%; height: 100%; }
    #mockupCanvas { background: #fff; max-height: 100%; max-width: 100%; object-fit: contain; border: 1px solid #ccc; transform-origin: center center; transition: transform 0.2s ease; }

    /* Thanh công cụ */
    #toolbar { display: flex; justify-content: center; align-items: center; gap: 5px; padding: 8px; border-top: 1px solid #ccc; background: #f9f9f9; flex-wrap: wrap; }
    #toolbar input, #toolbar select, #toolbar button { padding: 4px 6px; font-size: 14px; }
    #zoomControls button { padding: 4px 8px; }

    /* ==== FONT CUSTOM ==== */
    @font-face {
      font-family: 'UVF Aphrodite Pro';
      src: url('fonts/[cnttqn.net] UVF Aphrodite Pro.ttf') format('truetype');
    }
    @font-face {
      font-family: 'SVN Dancing Script';
      src: url('fonts/SVN-Dancing script.ttf') format('truetype');
    }
    @font-face {
      font-family: 'SVN Rosellinda Alyamore';
      src: url('fonts/SVN-ROSELLINDA ALYAMORE.OTF') format('opentype');
    }
    @font-face {
      font-family: 'UTM Androgyne';
      src: url('fonts/UTM Androgyne.ttf') format('truetype');
    }
    @font-face {
      font-family: 'UTM Zirkon';
      src: url('fonts/UTM Zirkon.ttf') format('truetype');
    }
    @font-face {
      font-family: 'UVF Candlescript Pro';
      src: url('fonts/UVF Candlescript Pro.otf') format('opentype');
    }
  </style>
</head>
<body>
  <div id="leftPanel">
    <h3>Hình mẫu </h3>
    <input type="file" id="uploadLogos" multiple accept="image/*"><br><br>
    <div id="logoList"></div>
  </div>

  <div id="centerPanel">
    <div id="canvasWrapper">
      <canvas id="mockupCanvas"></canvas>
    </div>
    <div id="toolbar">
      <input type="text" id="textInput" placeholder="Thêm chữ vào đây">
      <select id="fontSelect">
        <option value="Arial">Arial</option>
        <option value="Tahoma">Tahoma</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
        <option value="UVF Aphrodite Pro">UVF Aphrodite Pro</option>
        <option value="SVN Dancing Script">SVN Dancing Script</option>
        <option value="SVN Rosellinda Alyamore">SVN Rosellinda Alyamore</option>
        <option value="UTM Androgyne">UTM Androgyne</option>
        <option value="UTM Zirkon">UTM Zirkon</option>
        <option value="UVF Candlescript Pro">UVF Candlescript Pro</option>
      </select>
      <input type="color" id="colorPicker" value="#000000">
      <button id="btnAddText">Thêm chữ</button>
      <button id="btnDelete">Xóa</button>
      <button id="btnUndo">Quay lại</button>
      <button id="btnExportJPG">Lưu JPG</button>
      <button id="btnExportPNG">Lưu PNG</button>
      <div id="zoomControls">
        <button id="btnZoomOut">➖</button>
        <button id="btnZoomIn">➕</button>
      </div>
      <button id="btnSaveProject">💾 Lưu Project</button>
    </div>
  </div>

  <div id="rightPanel">
    <h3>Bình mẫu</h3>
    <input type="file" id="uploadMockups" multiple accept="image/*"><br><br>
    <div id="mockupList"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    const canvas = new fabric.Canvas('mockupCanvas', { selection: true, preserveObjectStacking: true });
    const wrapper = document.getElementById('canvasWrapper');
    let currentMockup = null;
    let history = [];
    let scaleFactor = 1;

    function resizeCanvas(){ canvas.setWidth(wrapper.clientWidth); canvas.setHeight(wrapper.clientHeight); canvas.renderAll(); }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function zoom(delta){
      scaleFactor += delta; if(scaleFactor<0.2) scaleFactor=0.2; if(scaleFactor>3) scaleFactor=3;
      canvas.setZoom(scaleFactor); canvas.requestRenderAll();
    }

    function renderThumbs(){
      const ll = document.getElementById('logoList');
      const ml = document.getElementById('mockupList');
      ll.innerHTML = ''; ml.innerHTML='';
      if(window.PRELOAD){
        PRELOAD.logos.forEach(src=>{
          const im=document.createElement('img'); im.src=src; im.addEventListener('click',()=>addImage(src,true)); ll.appendChild(im);
        });
        PRELOAD.mockups.forEach(src=>{
          const im=document.createElement('img'); im.src=src; im.addEventListener('click',()=>setMockup(src)); ml.appendChild(im);
        });
      }
    }

    document.getElementById('uploadLogos').addEventListener('change', function(e){
      const list=document.getElementById('logoList'); list.innerHTML='';
      [...e.target.files].forEach(file=>{
        const r=new FileReader(); r.onload=ev=>{
          const im=document.createElement('img'); im.src=ev.target.result; im.addEventListener('click',()=>addImage(ev.target.result,true)); list.appendChild(im);
        }; r.readAsDataURL(file);
      });
    });

    document.getElementById('uploadMockups').addEventListener('change', function(e){
      const list=document.getElementById('mockupList'); list.innerHTML='';
      [...e.target.files].forEach(file=>{
        const r=new FileReader(); r.onload=ev=>{
          const im=document.createElement('img'); im.src=ev.target.result; im.addEventListener('click',()=>setMockup(ev.target.result)); list.appendChild(im);
        }; r.readAsDataURL(file);
      });
    });

    function setMockup(src){
      fabric.Image.fromURL(src,function(img){
        canvas.clear(); currentMockup=img;
        img.selectable=false; img.evented=false; img.isMockup=true;
        const scale=Math.min(canvas.width/img.width, canvas.height/img.height);
        img.scale(scale); img.set({left:canvas.width/2,top:canvas.height/2,originX:'center',originY:'center'});
        canvas.add(img); saveHistory();
      });
    }

    function addImage(src, resizable){
      fabric.Image.fromURL(src,function(img){
        img.scale(0.3); img.set({left:canvas.width/2, top:canvas.height/2, originX:'center', originY:'center'});
        img.selectable=true; img.hasControls=resizable; canvas.add(img).setActiveObject(img); saveHistory();
      });
    }

    function addText(){
      const text=new fabric.Textbox(document.getElementById('textInput').value||'Nhập chữ ở đây',{
        left:canvas.width/2, top:canvas.height/2, fontFamily:document.getElementById('fontSelect').value,
        fill:document.getElementById('colorPicker').value, fontSize:24, originX:'center', originY:'center'
      });
      canvas.add(text).setActiveObject(text); saveHistory();
    }

    function deleteSelected(){
      const a=canvas.getActiveObject(); if(a && !a.isMockup){ canvas.remove(a); saveHistory(); }
    }

    function saveHistory(){ history.push(JSON.stringify(canvas.toJSON())); }

    function undo(){
      if(history.length>1){ history.pop();
        canvas.loadFromJSON(history[history.length-1], ()=>{ currentMockup=canvas.getObjects().find(o=>o.isMockup)||null; canvas.renderAll(); });
      }
    }

    function exportMockup(type){
      const url=canvas.toDataURL({format:type, quality:1}); const a=document.createElement('a'); a.href=url; a.download='mockup.'+type; a.click();
    }

    canvas.on('selection:created', e=>{
      e.selected.forEach(obj=>{ obj.set({borderColor:'red', cornerColor:'red', cornerStyle:'circle', transparentCorners:false}); });
      canvas.renderAll();
    });
    canvas.on('selection:cleared', ()=>canvas.renderAll());

    document.getElementById('btnAddText').onclick=addText;
    document.getElementById('btnDelete').onclick=deleteSelected;
    document.getElementById('btnUndo').onclick=undo;
    document.getElementById('btnExportJPG').onclick=()=>exportMockup('jpg');
    document.getElementById('btnExportPNG').onclick=()=>exportMockup('png');
    document.getElementById('btnZoomIn').onclick=()=>zoom(0.1);
    document.getElementById('btnZoomOut').onclick=()=>zoom(-0.1);

    document.getElementById('btnSaveProject').onclick=()=>{
      function saveProject() {
        const css = Array.from(document.querySelectorAll('style')).map(s => s.innerHTML).join('\n');
        const logos = Array.from(document.querySelectorAll('#logoList img')).map(i => i.src);
        const mockups = Array.from(document.querySelectorAll('#mockupList img')).map(i => i.src);
        const canvasJSON = JSON.stringify(canvas.toJSON());
        const savedHTML = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mockup Saved Project</title>
  <style>${css}</style>
</head>
<body>
  <div id="leftPanel"><h3>Hình mẫu</h3><input type="file" id="uploadLogos" multiple accept="image/*"><br><br><div id="logoList"></div></div>
  <div id="centerPanel"><div id="canvasWrapper"><canvas id="mockupCanvas"></canvas></div>
  <div id="toolbar">
    <input type="text" id="textInput" placeholder="Thêm chữ vào đây">
    <select id="fontSelect">
      <option value="Arial">Arial</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Verdana">Verdana</option>
      <option value="UVF Aphrodite Pro">UVF Aphrodite Pro</option>
      <option value="SVN Dancing Script">SVN Dancing Script</option>
      <option value="SVN Rosellinda Alyamore">SVN Rosellinda Alyamore</option>
      <option value="UTM Androgyne">UTM Androgyne</option>
      <option value="UTM Zirkon">UTM Zirkon</option>
      <option value="UVF Candlescript Pro">UVF Candlescript Pro</option>
    </select>
    <input type="color" id="colorPicker" value="#000000">
    <button id="btnAddText">Thêm chữ</button>
    <button id="btnDelete">Xóa</button>
    <button id="btnUndo">Quay lại</button>
    <button id="btnExportJPG">Lưu JPG</button>
    <button id="btnExportPNG">Lưu PNG</button>
    <div id="zoomControls"><button id="btnZoomOut">➖</button><button id="btnZoomIn">➕</button></div>
    <button id="btnSaveProject"<button>
  </div></div>
  <div id="rightPanel"><h3>Bình mẫu</h3><input type="file" id="uploadMockups" multiple accept="image/*"><br><br><div id="mockupList"></div></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"><\/script>
  <script>
    const PRELOAD = { logos: ${JSON.stringify(logos)}, mockups: ${JSON.stringify(mockups)}, canvasJSON: ${JSON.stringify(canvasJSON)} };
    // chèn lại code JS gốc...
  <\/script>
</body></html>`;
        const blob = new Blob([savedHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mockup_saved.html';
        a.click();
      }
      saveProject();
    };

   
   // ✅ Đổi font trực tiếp khi chọn dropdown
    document.getElementById("fontSelect").addEventListener("change", function () {
      let selectedFont = this.value;
      const active = canvas.getActiveObject();
      if (active && active.type === 'textbox') {
        active.set("fontFamily", selectedFont);
        canvas.requestRenderAll();
      }
    });
  </script>
</body>
</html>